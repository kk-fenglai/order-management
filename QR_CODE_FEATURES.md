# 二维码功能说明

## 🎯 功能概述

系统现在支持在创建包裹时自动生成取件码二维码，无需等待货物到达咖啡馆。这大大提高了工作效率，让您可以提前准备二维码。

## ✨ 新功能特性

### 1. 自动二维码生成
- **创建包裹时自动生成**: 每次创建新包裹时，系统会自动生成取件码和对应的二维码
- **二维码内容**: 包含移动端取件码页面的URL，扫描后可直接查看取件码
- **存储方式**: 二维码以base64格式存储在数据库中，无需额外文件存储

### 2. 二维码管理
- **查看所有二维码**: 在二维码页面可以查看所有包裹的二维码，按状态分组显示
- **重新生成**: 如果二维码生成失败，可以手动重新生成
- **打印功能**: 支持打印单个二维码，方便贴在包裹上

### 3. 移动端优化
- **取件码搜索**: 移动端页面支持通过取件码直接搜索包裹
- **二维码扫描**: 扫描二维码可直接跳转到对应包裹的取件码页面
- **状态显示**: 显示包裹的当前状态（已到深圳/已到咖啡馆/已取件）

## 🔧 技术实现

### 数据库变更
```sql
-- 新增二维码字段
ALTER TABLE package ADD COLUMN qr_code_image TEXT;
```

### 核心方法
```python
# 生成二维码
Package.generate_qr_code(pickup_code, base_url)

# 创建包裹并生成二维码
Package.create_package_with_qr(customer_name, customer_email, tracking_number, notes, base_url)
```

### 二维码内容格式
```
http://your-domain.com/mobile_pickup?code=123456
```

## 📱 使用流程

### 1. 创建包裹
1. 进入"新建包裹"页面
2. 填写包裹信息
3. 系统自动生成取件码和二维码
4. 可以立即查看和打印二维码

### 2. 查看二维码
1. 进入"二维码"页面
2. 按状态筛选包裹（全部/已到深圳/已到咖啡馆/已取件）
3. 查看每个包裹的二维码
4. 支持打印单个二维码

### 3. 移动端使用
1. 扫描二维码
2. 自动跳转到移动端取件码页面
3. 显示对应包裹的取件码信息
4. 支持标记已取件

## 🚀 部署说明

### 1. 数据库迁移
```bash
# 运行迁移脚本，为现有包裹生成二维码
python migrate_add_qr_code.py
```

### 2. 环境变量配置
```bash
# 设置服务器地址（用于生成二维码URL）
export BASE_URL="https://your-domain.com"
```

### 3. 依赖检查
确保已安装以下依赖：
```bash
pip install qrcode[pil]
```

## 📊 功能对比

| 功能 | 旧版本 | 新版本 |
|------|--------|--------|
| 二维码生成时机 | 货物到达咖啡馆后 | 创建包裹时立即生成 |
| 二维码存储 | 临时生成 | 永久存储在数据库 |
| 二维码查看 | 仅限已到咖啡馆包裹 | 所有包裹都可查看 |
| 移动端搜索 | 不支持 | 支持取件码搜索 |
| 二维码重新生成 | 不支持 | 支持手动重新生成 |

## 🔍 页面说明

### 1. 二维码页面 (`/qr_codes`)
- 显示所有包裹的二维码
- 按状态分组筛选
- 支持打印功能
- 显示包裹详细信息

### 2. 移动端取件码页面 (`/mobile_pickup`)
- 支持取件码搜索
- 显示包裹状态
- 支持标记已取件
- 统计信息显示

### 3. 包裹详情页面
- 显示包裹的二维码
- 支持重新生成二维码
- 显示二维码状态

## 🛠️ 故障排除

### 1. 二维码生成失败
- 检查 `BASE_URL` 配置是否正确
- 确认 `qrcode` 库已正确安装
- 查看日志文件中的错误信息

### 2. 二维码显示异常
- 检查数据库中的 `qr_code_image` 字段
- 确认base64编码格式正确
- 尝试重新生成二维码

### 3. 移动端无法访问
- 确认 `BASE_URL` 配置正确
- 检查网络连接
- 验证服务器是否正常运行

## 📈 性能优化

### 1. 二维码生成优化
- 使用缓存机制避免重复生成
- 异步生成大量二维码
- 压缩二维码图片大小

### 2. 数据库优化
- 定期清理无效的二维码数据
- 优化查询性能
- 添加适当的索引

## 🔮 未来计划

1. **批量二维码生成**: 支持批量生成和打印二维码
2. **二维码模板**: 支持自定义二维码样式和布局
3. **二维码统计**: 添加二维码扫描统计功能
4. **离线支持**: 支持离线查看二维码

## 📞 技术支持

如果在使用过程中遇到问题，请：
1. 查看日志文件
2. 检查配置是否正确
3. 联系技术支持团队 